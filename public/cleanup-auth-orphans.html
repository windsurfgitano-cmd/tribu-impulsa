<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiar Cuentas Hu√©rfanas de Firebase Auth</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #181B34;
      color: white;
    }
    button {
      background: #6161FF;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #4848CC;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    pre {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
    }
    .warning {
      background: #FF6B6B;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .info {
      background: #6161FF;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üßπ Limpiar Cuentas Hu√©rfanas de Firebase Authentication</h1>
  
  <div class="info">
    ‚ÑπÔ∏è <strong>¬øQu√© son cuentas hu√©rfanas?</strong><br>
    Cuentas que existen en Firebase Authentication pero NO tienen perfil en Firestore /users.
    Esto causa errores de login porque el sistema no encuentra el perfil del usuario.
  </div>

  <div class="warning">
    ‚ö†Ô∏è <strong>ADVERTENCIA:</strong> Este script BORRAR√Å PERMANENTEMENTE las cuentas de Authentication que no tengan perfil en Firestore.
    <br><br>
    <strong>NOTA IMPORTANTE:</strong> Firebase Authentication no permite listar usuarios desde el frontend.
    Este script solo puede verificar las cuentas que T√ö ingreses manualmente.
  </div>

  <h2>üîç Verificar Email:</h2>
  <input type="email" id="emailInput" placeholder="email@ejemplo.com" style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #444; background: #222; color: white;">
  <button onclick="checkEmail()">Verificar Email</button>
  
  <h2>üóëÔ∏è Limpiar Hu√©rfanas Conocidas:</h2>
  <button onclick="cleanupKnownOrphans()">Limpiar: rincondeoz@gmail.com</button>
  
  <h2>üìã Resultados:</h2>
  <pre id="output">Ingresa un email para verificar si es una cuenta hu√©rfana...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, deleteUser, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-RMcSBZ7eY9Y4CgH9Y0N6UKAj5Db_X4U",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "426607949701",
      appId: "1:426607949701:web:42effc9ce4a2bf1df90738",
      measurementId: "G-0R4H8ETRDB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const output = document.getElementById('output');

    const UNIVERSAL_PASSWORD = 'TRIBU2026';

    window.checkEmail = async function() {
      const emailInput = document.getElementById('emailInput');
      const email = emailInput.value.trim().toLowerCase();
      
      if (!email) {
        alert('Por favor ingresa un email');
        return;
      }

      output.textContent = `üîç Verificando ${email}...\n\n`;
      
      try {
        // 1. Verificar si existe en Firestore
        output.textContent += 'üì¶ PASO 1: Verificando Firestore /users...\n';
        const usersCollection = collection(db, 'users');
        const snapshot = await getDocs(usersCollection);
        
        const existsInFirestore = snapshot.docs.some(doc => {
          const data = doc.data();
          return data.email && data.email.toLowerCase() === email;
        });
        
        if (existsInFirestore) {
          output.textContent += `‚úÖ Perfil encontrado en Firestore\n\n`;
        } else {
          output.textContent += `‚ùå NO existe en Firestore\n\n`;
        }
        
        // 2. Intentar login para verificar si existe en Authentication
        output.textContent += 'üîê PASO 2: Verificando Firebase Authentication...\n';
        
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, UNIVERSAL_PASSWORD);
          output.textContent += `‚úÖ Cuenta existe en Authentication (UID: ${userCredential.user.uid})\n\n`;
          
          // Cerrar sesi√≥n inmediatamente
          await signOut(auth);
          
          // 3. Diagn√≥stico
          output.textContent += 'üìä DIAGN√ìSTICO:\n';
          if (existsInFirestore) {
            output.textContent += '‚úÖ Cuenta NORMAL - Existe en Auth y Firestore\n';
            output.textContent += '   No requiere limpieza\n';
          } else {
            output.textContent += '‚ö†Ô∏è Cuenta HU√âRFANA - Existe en Auth pero NO en Firestore\n';
            output.textContent += '   Esta cuenta debe ser eliminada de Authentication\n';
            output.textContent += '\nüí° Usa el bot√≥n "Limpiar Hu√©rfanas Conocidas" para eliminarla\n';
          }
        } catch (authError) {
          output.textContent += `‚ùå NO existe en Authentication: ${authError.code}\n\n`;
          output.textContent += 'üìä DIAGN√ìSTICO:\n';
          output.textContent += '‚ùå Cuenta NO existe en Authentication\n';
          output.textContent += '   No requiere limpieza\n';
        }
        
      } catch (error) {
        output.textContent += `\n‚ùå Error: ${error.message}\n`;
        console.error(error);
      }
    };

    window.cleanupKnownOrphans = async function() {
      const orphanEmails = ['rincondeoz@gmail.com'];
      
      const confirmed = confirm(
        `‚ö†Ô∏è ¬øELIMINAR las siguientes cuentas de Firebase Authentication?\n\n` +
        orphanEmails.join('\n') +
        `\n\nEsto es IRREVERSIBLE. Los usuarios deber√°n registrarse de nuevo.\n\n¬øContinuar?`
      );
      
      if (!confirmed) {
        output.textContent = 'Operaci√≥n cancelada por el usuario.\n';
        return;
      }
      
      output.textContent = 'üßπ Iniciando limpieza de cuentas hu√©rfanas...\n\n';
      
      let deletedCount = 0;
      let errorCount = 0;
      
      for (const email of orphanEmails) {
        try {
          output.textContent += `üìß Procesando: ${email}\n`;
          
          // 1. Verificar que NO existe en Firestore
          const usersCollection = collection(db, 'users');
          const snapshot = await getDocs(usersCollection);
          
          const existsInFirestore = snapshot.docs.some(doc => {
            const data = doc.data();
            return data.email && data.email.toLowerCase() === email.toLowerCase();
          });
          
          if (existsInFirestore) {
            output.textContent += `   ‚ö†Ô∏è SKIP: Existe en Firestore, no es hu√©rfana\n\n`;
            continue;
          }
          
          // 2. Intentar login y eliminar
          try {
            const userCredential = await signInWithEmailAndPassword(auth, email, UNIVERSAL_PASSWORD);
            const user = userCredential.user;
            
            output.textContent += `   üîê Autenticado (UID: ${user.uid})\n`;
            
            // Eliminar usuario
            await deleteUser(user);
            
            deletedCount++;
            output.textContent += `   ‚úÖ ELIMINADO de Firebase Authentication\n\n`;
          } catch (authError) {
            if (authError.code === 'auth/user-not-found' || authError.code === 'auth/wrong-password') {
              output.textContent += `   ‚ÑπÔ∏è Ya no existe en Authentication\n\n`;
            } else if (authError.code === 'auth/requires-recent-login') {
              output.textContent += `   ‚ö†Ô∏è Requiere re-autenticaci√≥n reciente (eliminar manualmente desde Firebase Console)\n\n`;
              errorCount++;
            } else {
              output.textContent += `   ‚ùå Error: ${authError.code} - ${authError.message}\n\n`;
              errorCount++;
            }
          }
          
        } catch (error) {
          output.textContent += `   ‚ùå Error general: ${error.message}\n\n`;
          errorCount++;
        }
      }
      
      output.textContent += '\n‚úÖ LIMPIEZA COMPLETADA\n';
      output.textContent += `   ‚úÖ Eliminadas: ${deletedCount}\n`;
      output.textContent += `   ‚ùå Errores: ${errorCount}\n`;
      output.textContent += `   üìä Total procesadas: ${orphanEmails.length}\n`;
      
      if (errorCount > 0) {
        output.textContent += '\n‚ö†Ô∏è Algunas cuentas requieren eliminaci√≥n manual desde Firebase Console:\n';
        output.textContent += 'https://console.firebase.google.com/u/0/project/tribu-impulsa/authentication/users\n';
      }
      
      setTimeout(() => {
        if (confirm('‚úÖ Limpieza completada.\n\n¬øRecargar la p√°gina?')) {
          window.location.reload();
        }
      }, 1000);
    };
  </script>
</body>
</html>

