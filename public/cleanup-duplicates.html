<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üßπ Limpiar Duplicados</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #6161FF;
      margin-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .info { background: #E3F2FD; border-left: 4px solid #2196F3; }
    .success { background: #E8F5E9; border-left: 4px solid #4CAF50; }
    .error { background: #FFEBEE; border-left: 4px solid #F44336; }
    .warning { background: #FFF3E0; border-left: 4px solid #FF9800; }
    button {
      background: linear-gradient(135deg, #6161FF 0%, #8B5CF6 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(97,97,255,0.4); }
    button.danger { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); }
    .user-card {
      background: #F5F7FB;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid #FF9800;
    }
    .user-card.duplicate {
      border-left-color: #F44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Limpiar Usuarios Duplicados</h1>
    <p>Esta herramienta eliminar√° usuarios duplicados, manteniendo el M√ÅS RECIENTE.</p>
    
    <div id="status"></div>
    <div id="users"></div>
    
    <button onclick="showDuplicates()">üîç Buscar Duplicados</button>
    <button onclick="cleanupDuplicates()" class="danger">üóëÔ∏è ELIMINAR DUPLICADOS (LOCAL)</button>
    <button onclick="cleanupFirebase()" class="danger">üî• ELIMINAR DUPLICADOS (FIREBASE)</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDvAxWWNJYxW_VEDrjXLcjxoGaCQnqPVGk",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "614984945425",
      appId: "1:614984945425:web:ec9e8ca01ddb88d98a79d6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      document.getElementById('status').appendChild(div);
      console.log(message.replace(/<[^>]*>/g, ''));
    }

    window.showDuplicates = function() {
      document.getElementById('status').innerHTML = '';
      document.getElementById('users').innerHTML = '';
      
      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      const emailMap = new Map();

      users.forEach(user => {
        const email = (user.email || '').toLowerCase();
        if (!emailMap.has(email)) {
          emailMap.set(email, []);
        }
        emailMap.get(email).push(user);
      });

      let duplicateCount = 0;
      for (const [email, userList] of emailMap.entries()) {
        if (userList.length > 1) {
          duplicateCount += userList.length - 1;
          log(`‚ö†Ô∏è <strong>${email}</strong> tiene ${userList.length} cuentas:`, 'warning');
          
          userList.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          
          userList.forEach((user, idx) => {
            const card = document.createElement('div');
            card.className = idx === 0 ? 'user-card' : 'user-card duplicate';
            card.innerHTML = `
              ${idx === 0 ? '‚úÖ MANTENER' : 'üóëÔ∏è ELIMINAR'} - <strong>${user.name}</strong><br>
              ID: ${user.id}<br>
              Creado: ${new Date(user.createdAt).toLocaleString()}
            `;
            document.getElementById('users').appendChild(card);
          });
        }
      }

      if (duplicateCount === 0) {
        log('‚úÖ No se encontraron duplicados', 'success');
      } else {
        log(`üìä Total de duplicados a eliminar: <strong>${duplicateCount}</strong>`, 'info');
      }
    };

    window.cleanupDuplicates = function() {
      if (!confirm('¬øELIMINAR duplicados del LOCALSTORAGE? Los m√°s antiguos ser√°n eliminados.')) return;

      document.getElementById('status').innerHTML = '';
      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      const emailMap = new Map();

      users.forEach(user => {
        const email = (user.email || '').toLowerCase();
        if (!emailMap.has(email)) {
          emailMap.set(email, []);
        }
        emailMap.get(email).push(user);
      });

      const cleanUsers = [];
      let removed = 0;

      for (const [email, userList] of emailMap.entries()) {
        if (userList.length > 1) {
          userList.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          log(`‚úÖ Manteniendo ${userList[0].name} (m√°s reciente)`, 'success');
          cleanUsers.push(userList[0]);
          removed += userList.length - 1;
        } else {
          cleanUsers.push(userList[0]);
        }
      }

      localStorage.setItem('tribu_users', JSON.stringify(cleanUsers));
      log(`üéâ Limpieza completada: ${removed} duplicados eliminados`, 'success');
    };

    window.cleanupFirebase = async function() {
      if (!confirm('¬øELIMINAR duplicados de FIREBASE? Los m√°s antiguos ser√°n eliminados. ESTO NO SE PUEDE DESHACER.')) return;

      document.getElementById('status').innerHTML = '';
      log('üî• Buscando duplicados en Firebase...', 'info');

      try {
        const querySnapshot = await getDocs(collection(db, 'users'));
        const emailMap = new Map();

        querySnapshot.forEach(doc => {
          const data = doc.data();
          const email = (data.email || '').toLowerCase();
          if (!emailMap.has(email)) {
            emailMap.set(email, []);
          }
          emailMap.get(email).push({ id: doc.id, ...data });
        });

        let removed = 0;
        for (const [email, userList] of emailMap.entries()) {
          if (userList.length > 1) {
            userList.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            log(`‚úÖ Manteniendo ${userList[0].name} en Firebase`, 'success');
            
            for (let i = 1; i < userList.length; i++) {
              await deleteDoc(doc(db, 'users', userList[i].id));
              log(`üóëÔ∏è Eliminado ${userList[i].name} (${userList[i].id})`, 'warning');
              removed++;
            }
          }
        }

        log(`üéâ Limpieza Firebase completada: ${removed} duplicados eliminados`, 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    };

    // Auto-mostrar duplicados al cargar
    setTimeout(showDuplicates, 500);
  </script>
</body>
</html>

