<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üö® SINCRONIZACI√ìN DE EMERGENCIA</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #6161FF;
      margin-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .info { background: #E3F2FD; border-left: 4px solid #2196F3; }
    .success { background: #E8F5E9; border-left: 4px solid #4CAF50; }
    .error { background: #FFEBEE; border-left: 4px solid #F44336; }
    .warning { background: #FFF3E0; border-left: 4px solid #FF9800; }
    button {
      background: linear-gradient(135deg, #6161FF 0%, #8B5CF6 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(97,97,255,0.4); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .user-card {
      background: #F5F7FB;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid #6161FF;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üö® Sincronizaci√≥n de Emergencia</h1>
    <p>Este script forzar√° la sincronizaci√≥n de TODOS los usuarios de localStorage a Firebase.</p>
    
    <div id="status"></div>
    <div id="users"></div>
    
    <button onclick="checkLocalUsers()">üìã Ver usuarios en Local</button>
    <button onclick="syncAllToFirebase()" style="background: linear-gradient(135deg, #00CA72 0%, #00A85A 100%);">
      ‚òÅÔ∏è SINCRONIZAR TODO A FIREBASE
    </button>
    <button onclick="verifyFirebase()" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);">
      üîç Verificar en Firebase
    </button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDvAxWWNJYxW_VEDrjXLcjxoGaCQnqPVGk",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "614984945425",
      appId: "1:614984945425:web:ec9e8ca01ddb88d98a79d6",
      measurementId: "G-W1HEZXP83S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      document.getElementById('status').appendChild(div);
      console.log(message.replace(/<[^>]*>/g, ''));
    }

    window.checkLocalUsers = function() {
      document.getElementById('status').innerHTML = '';
      document.getElementById('users').innerHTML = '';
      
      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      
      if (users.length === 0) {
        log('‚ö†Ô∏è No hay usuarios en localStorage', 'warning');
        return;
      }

      log(`üì¶ Encontrados <strong>${users.length}</strong> usuarios en localStorage:`, 'info');
      
      users.forEach((user, idx) => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
          <strong>#${idx + 1}: ${user.name}</strong><br>
          üìß ${user.email}<br>
          üè¢ ${user.companyName}<br>
          üì± ${user.instagram || 'Sin IG'}<br>
          üÜî ID: ${user.id}
        `;
        document.getElementById('users').appendChild(card);
      });
    };

    window.syncAllToFirebase = async function() {
      document.getElementById('status').innerHTML = '';
      log('üöÄ Iniciando sincronizaci√≥n de emergencia...', 'info');

      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      
      if (users.length === 0) {
        log('‚ùå No hay usuarios para sincronizar', 'error');
        return;
      }

      let synced = 0;
      let errors = 0;

      for (const user of users) {
        try {
          log(`‚è≥ Sincronizando: <strong>${user.name}</strong> (${user.email})...`, 'info');
          
          await setDoc(doc(db, 'users', user.id), {
            ...user,
            syncedAt: new Date().toISOString(),
            updatedAt: serverTimestamp()
          }, { merge: true });

          synced++;
          log(`‚úÖ <strong>${user.name}</strong> sincronizado correctamente`, 'success');
        } catch (error) {
          errors++;
          log(`‚ùå Error sincronizando ${user.name}: ${error.message}`, 'error');
          console.error('Error completo:', error);
        }
      }

      log(`<br>üéâ <strong>SINCRONIZACI√ìN COMPLETA</strong><br>‚úÖ Exitosos: ${synced}<br>‚ùå Errores: ${errors}`, 
          errors === 0 ? 'success' : 'warning');
    };

    window.verifyFirebase = async function() {
      document.getElementById('status').innerHTML = '';
      log('üîç Verificando usuarios en Firebase...', 'info');

      try {
        const querySnapshot = await getDocs(collection(db, 'users'));
        
        if (querySnapshot.empty) {
          log('‚ö†Ô∏è No hay usuarios en Firebase', 'warning');
          return;
        }

        log(`‚úÖ Encontrados <strong>${querySnapshot.size}</strong> usuarios en Firebase:`, 'success');
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          log(`üìã ${data.name} - ${data.email} (ID: ${doc.id})`, 'info');
        });
      } catch (error) {
        log(`‚ùå Error verificando Firebase: ${error.message}`, 'error');
      }
    };

    // Auto-verificar al cargar
    setTimeout(() => {
      checkLocalUsers();
    }, 500);
  </script>
</body>
</html>

