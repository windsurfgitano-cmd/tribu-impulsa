<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîÑ Sincronizar localStorage ‚Üí Firebase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #6161FF;
      margin-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .info { background: #E3F2FD; border-left: 4px solid #2196F3; }
    .success { background: #E8F5E9; border-left: 4px solid #4CAF50; }
    .error { background: #FFEBEE; border-left: 4px solid #F44336; }
    .warning { background: #FFF3E0; border-left: 4px solid #FF9800; }
    button {
      background: linear-gradient(135deg, #6161FF 0%, #8B5CF6 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(97,97,255,0.4); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.success { background: linear-gradient(135deg, #00CA72 0%, #00A85A 100%); }
    button.danger { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); }
    .user-card {
      background: #F5F7FB;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid #6161FF;
    }
    .step {
      background: white;
      border: 2px solid #6161FF;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
    }
    .step h3 {
      color: #6161FF;
      margin-top: 0;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Sincronizar localStorage ‚Üí Firebase</h1>
    <p><strong>Diagn√≥stico y sincronizaci√≥n de cuentas</strong></p>
    
    <div class="step">
      <h3>PASO 1: Ver qu√© hay en localStorage</h3>
      <button onclick="checkLocalStorage()">üì¶ Ver localStorage</button>
      <div id="local-users"></div>
    </div>

    <div class="step">
      <h3>PASO 2: Ver qu√© hay en Firebase Authentication</h3>
      <button onclick="checkFirebaseAuth()">üîê Ver Firebase Auth</button>
      <div id="auth-users"></div>
    </div>

    <div class="step">
      <h3>PASO 3: Ver qu√© hay en Firestore</h3>
      <button onclick="checkFirestore()">üì¶ Ver Firestore</button>
      <div id="firestore-users"></div>
    </div>

    <div class="step">
      <h3>PASO 4: SINCRONIZAR TODO</h3>
      <p>Esto tomar√° las cuentas de <strong>localStorage</strong> y las crear√° en:</p>
      <ul>
        <li>‚úÖ Firebase Authentication</li>
        <li>‚úÖ Firestore /users</li>
        <li>‚úÖ Actualizar contador</li>
      </ul>
      <button onclick="syncAllToFirebase()" class="success">‚òÅÔ∏è SINCRONIZAR TODO A FIREBASE</button>
    </div>

    <div class="step">
      <h3>PASO 5: Limpiar localStorage (opcional)</h3>
      <button onclick="clearLocalStorage()" class="danger">üóëÔ∏è Limpiar localStorage</button>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getAuth, createUserWithEmailAndPassword, fetchSignInMethodsForEmail } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDvAxWWNJYxW_VEDrjXLcjxoGaCQnqPVGk",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "614984945425",
      appId: "1:614984945425:web:ec9e8ca01ddb88d98a79d6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      document.getElementById('status').appendChild(div);
      console.log(message.replace(/<[^>]*>/g, ''));
    }

    window.checkLocalStorage = function() {
      const container = document.getElementById('local-users');
      container.innerHTML = '';
      
      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="status warning">‚ö†Ô∏è No hay usuarios en localStorage</div>';
        return;
      }

      container.innerHTML = `<div class="status success">‚úÖ ${users.length} usuarios en localStorage</div>`;
      
      users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
          <strong>${user.name || 'Sin nombre'}</strong><br>
          üìß ${user.email || 'Sin email'}<br>
          üè¢ ${user.companyName || 'Sin empresa'}<br>
          üì± ${user.instagram || 'Sin IG'}<br>
          üÜî <code>${user.id}</code><br>
          üìÖ ${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}
        `;
        container.appendChild(card);
      });
    };

    window.checkFirebaseAuth = async function() {
      const container = document.getElementById('auth-users');
      container.innerHTML = '<div class="status info">üîç Verificando Firebase Authentication...</div>';
      
      try {
        const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
        
        if (users.length === 0) {
          container.innerHTML = '<div class="status warning">‚ö†Ô∏è No hay usuarios en localStorage para verificar</div>';
          return;
        }

        let existsInAuth = 0;
        let notInAuth = 0;

        for (const user of users) {
          try {
            const methods = await fetchSignInMethodsForEmail(auth, user.email);
            if (methods.length > 0) {
              existsInAuth++;
              container.innerHTML += `<div class="status success">‚úÖ ${user.email} existe en Auth</div>`;
            } else {
              notInAuth++;
              container.innerHTML += `<div class="status warning">‚ö†Ô∏è ${user.email} NO existe en Auth</div>`;
            }
          } catch (error) {
            notInAuth++;
            container.innerHTML += `<div class="status error">‚ùå ${user.email}: ${error.message}</div>`;
          }
        }

        container.innerHTML = `<div class="status info"><strong>Resumen Auth:</strong><br>‚úÖ En Auth: ${existsInAuth}<br>‚ùå No en Auth: ${notInAuth}</div>` + container.innerHTML;
      } catch (error) {
        container.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    };

    window.checkFirestore = async function() {
      const container = document.getElementById('firestore-users');
      container.innerHTML = '<div class="status info">üîç Verificando Firestore...</div>';
      
      try {
        const querySnapshot = await getDocs(collection(db, 'users'));
        
        if (querySnapshot.empty) {
          container.innerHTML = '<div class="status warning">‚ö†Ô∏è No hay usuarios en Firestore</div>';
          return;
        }

        container.innerHTML = `<div class="status success">‚úÖ ${querySnapshot.size} usuarios en Firestore</div>`;
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement('div');
          card.className = 'user-card';
          card.innerHTML = `
            <strong>${data.name || 'Sin nombre'}</strong><br>
            üìß ${data.email || 'Sin email'}<br>
            üÜî <code>${doc.id}</code>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        container.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    };

    window.syncAllToFirebase = async function() {
      const users = JSON.parse(localStorage.getItem('tribu_users') || '[]');
      
      if (users.length === 0) {
        log('‚ùå No hay usuarios en localStorage para sincronizar', 'error');
        return;
      }

      if (!confirm(`¬øSincronizar ${users.length} usuarios a Firebase?\n\nSe crear√°n en:\n- Firebase Authentication\n- Firestore /users\n- Se actualizar√° el contador`)) {
        return;
      }

      log(`üöÄ Iniciando sincronizaci√≥n de ${users.length} usuarios...`, 'info');

      let created = 0;
      let errors = 0;

      for (const user of users) {
        try {
          log(`<br>‚è≥ Procesando: <strong>${user.name}</strong> (${user.email})...`, 'info');

          // PASO 1: Crear en Firebase Authentication
          try {
            const userCredential = await createUserWithEmailAndPassword(
              auth, 
              user.email, 
              user.password || 'TRIBU2026'
            );
            log(`üîê ‚úÖ Creado en Authentication (UID: ${userCredential.user.uid})`, 'success');
          } catch (authError) {
            if (authError.code === 'auth/email-already-in-use') {
              log(`üîê ‚ö†Ô∏è Ya existe en Authentication`, 'warning');
            } else {
              throw authError;
            }
          }

          // PASO 2: Crear en Firestore
          await setDoc(doc(db, 'users', user.id), {
            ...user,
            syncedAt: new Date().toISOString(),
            source: 'localStorage_sync'
          });
          log(`üì¶ ‚úÖ Guardado en Firestore`, 'success');

          created++;

        } catch (error) {
          errors++;
          log(`‚ùå Error con ${user.name}: ${error.message}`, 'error');
        }
      }

      // PASO 3: Actualizar contador
      try {
        const statsRef = doc(db, 'system_stats', 'global');
        await setDoc(statsRef, {
          profilesCompleted: created,
          membersActive: created,
          lastUpdated: new Date().toISOString()
        });
        log(`üìä ‚úÖ Contador actualizado: ${created}/1000`, 'success');
      } catch (error) {
        log(`‚ö†Ô∏è Error actualizando contador: ${error.message}`, 'warning');
      }

      log(`<br><br>üéâ <strong>SINCRONIZACI√ìN COMPLETADA</strong><br>‚úÖ Exitosos: ${created}<br>‚ùå Errores: ${errors}<br><br>Verifica en:<br>- Firebase Console ‚Üí Authentication<br>- Firebase Console ‚Üí Firestore /users`, 'success');
    };

    window.clearLocalStorage = function() {
      if (!confirm('‚ö†Ô∏è ¬øLimpiar localStorage?\n\nEsto borrar√° TODOS los datos locales.\nAseg√∫rate de haber sincronizado primero.')) {
        return;
      }

      localStorage.clear();
      log('‚úÖ localStorage limpiado', 'success');
      window.location.reload();
    };

    // Auto-verificar al cargar
    setTimeout(() => {
      checkLocalStorage();
    }, 500);
  </script>
</body>
</html>

