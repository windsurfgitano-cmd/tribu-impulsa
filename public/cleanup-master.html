<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpieza Maestra del Sistema - Tribu Impulsa</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #181B34;
      color: white;
    }
    button {
      background: #6161FF;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #4848CC;
    }
    button.danger {
      background: #FF6B6B;
    }
    button.danger:hover {
      background: #FF5252;
    }
    pre {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 600px;
      overflow-y: auto;
    }
    .warning {
      background: #FF6B6B;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .info {
      background: #6161FF;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success {
      background: #00CA72;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .step {
      background: #2A2D4A;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #6161FF;
    }
  </style>
</head>
<body>
  <h1>ğŸ§¹ Limpieza Maestra del Sistema - Tribu Impulsa v0.9.1</h1>
  
  <div class="info">
    â„¹ï¸ <strong>Â¿QuÃ© hace este script?</strong><br>
    Este es el script maestro que realiza una limpieza completa del sistema:
    <ul>
      <li>1. Limpia cuentas huÃ©rfanas de Firebase Authentication</li>
      <li>2. Elimina duplicados de Firestore /users</li>
      <li>3. Resetea el contador Rally a 0</li>
    </ul>
  </div>

  <div class="warning">
    âš ï¸ <strong>ADVERTENCIA CRÃTICA:</strong> Este script realizarÃ¡ cambios PERMANENTES en Firebase.
    <br><br>
    <strong>ANTES DE CONTINUAR:</strong>
    <ul>
      <li>âœ… AsegÃºrate de tener un backup si es necesario</li>
      <li>âœ… Solo ejecuta esto cuando quieras empezar desde cero</li>
      <li>âœ… Los usuarios huÃ©rfanos deberÃ¡n registrarse nuevamente</li>
    </ul>
  </div>

  <h2>ğŸ“‹ Pasos de Limpieza:</h2>
  
  <div class="step">
    <h3>PASO 1: Verificar Estado Actual</h3>
    <button onclick="checkCurrentState()">ğŸ” Verificar Estado</button>
  </div>

  <div class="step">
    <h3>PASO 2: Limpiar Duplicados de Firestore</h3>
    <button onclick="cleanupFirestoreDuplicates()">ğŸ—‘ï¸ Limpiar Duplicados</button>
  </div>

  <div class="step">
    <h3>PASO 3: Limpiar HuÃ©rfanas de Authentication</h3>
    <p>Emails conocidos: rincondeoz@gmail.com</p>
    <button onclick="cleanupOrphanAccounts()">ğŸ—‘ï¸ Limpiar HuÃ©rfanas</button>
  </div>

  <div class="step">
    <h3>PASO 4: Resetear Contador Rally</h3>
    <button onclick="resetRallyCounter()">ğŸ”„ Resetear a 0/1000</button>
  </div>

  <div class="step danger">
    <h3>âš¡ LIMPIEZA COMPLETA (TODO EN UNO)</h3>
    <button class="danger" onclick="fullCleanup()">ğŸ—‘ï¸ LIMPIAR TODO</button>
  </div>

  <h2>ğŸ“Š Resultados:</h2>
  <pre id="output">Presiona "Verificar Estado" para comenzar...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, deleteDoc, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, deleteUser, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-RMcSBZ7eY9Y4CgH9Y0N6UKAj5Db_X4U",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "426607949701",
      appId: "1:426607949701:web:42effc9ce4a2bf1df90738",
      measurementId: "G-0R4H8ETRDB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const output = document.getElementById('output');
    const UNIVERSAL_PASSWORD = 'TRIBU2026';

    window.checkCurrentState = async function() {
      output.textContent = 'ğŸ” VERIFICANDO ESTADO ACTUAL DEL SISTEMA...\n\n';
      
      try {
        // 1. Contar usuarios en Firestore
        output.textContent += 'ğŸ“¦ FIRESTORE /users:\n';
        const usersSnapshot = await getDocs(collection(db, 'users'));
        output.textContent += `   Total de documentos: ${usersSnapshot.docs.length}\n`;
        
        // Agrupar por email
        const emailMap = new Map();
        usersSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const email = (data.email || '').toLowerCase();
          if (!emailMap.has(email)) {
            emailMap.set(email, []);
          }
          emailMap.get(email).push({ id: doc.id, ...data });
        });
        
        let duplicatesCount = 0;
        for (const [email, users] of emailMap.entries()) {
          if (users.length > 1) {
            duplicatesCount += users.length - 1;
            output.textContent += `   âš ï¸ Duplicado: ${email} (${users.length} copias)\n`;
          }
        }
        
        output.textContent += `\n   Emails Ãºnicos: ${emailMap.size}\n`;
        output.textContent += `   Duplicados: ${duplicatesCount}\n\n`;
        
        // 2. Verificar contador Rally
        output.textContent += 'ğŸ¯ CONTADOR RALLY:\n';
        const statsDoc = await getDoc(doc(db, 'system_stats', 'global'));
        if (statsDoc.exists()) {
          const count = statsDoc.data().profilesCompleted || 0;
          output.textContent += `   Perfiles completados: ${count}/1000\n\n`;
        } else {
          output.textContent += `   âš ï¸ Documento no existe\n\n`;
        }
        
        output.textContent += 'âœ… VerificaciÃ³n completada\n';
        
      } catch (error) {
        output.textContent += `\nâŒ Error: ${error.message}\n`;
        console.error(error);
      }
    };

    window.cleanupFirestoreDuplicates = async function() {
      const confirmed = confirm('âš ï¸ Â¿ELIMINAR DUPLICADOS de Firestore?\n\nSolo se mantendrÃ¡ el documento mÃ¡s reciente por email.\n\nÂ¿Continuar?');
      if (!confirmed) return;
      
      output.textContent = 'ğŸ§¹ LIMPIANDO DUPLICADOS DE FIRESTORE...\n\n';
      
      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const emailMap = new Map();
        
        usersSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const email = (data.email || '').toLowerCase();
          if (!emailMap.has(email)) {
            emailMap.set(email, []);
          }
          emailMap.get(email).push({
            id: doc.id,
            email: data.email,
            name: data.name,
            createdAt: data.createdAt || '1970-01-01T00:00:00.000Z'
          });
        });
        
        let deletedCount = 0;
        
        for (const [email, users] of emailMap.entries()) {
          if (users.length > 1) {
            output.textContent += `\nğŸ“§ ${email}: ${users.length} copias\n`;
            
            // Ordenar por fecha (mÃ¡s reciente primero)
            users.sort((a, b) => {
              const dateA = new Date(a.createdAt).getTime();
              const dateB = new Date(b.createdAt).getTime();
              return dateB - dateA;
            });
            
            const toKeep = users[0];
            const toDelete = users.slice(1);
            
            output.textContent += `   âœ… Manteniendo: ${toKeep.id}\n`;
            
            for (const user of toDelete) {
              await deleteDoc(doc(db, 'users', user.id));
              deletedCount++;
              output.textContent += `   ğŸ—‘ï¸ Eliminado: ${user.id}\n`;
            }
          }
        }
        
        output.textContent += `\nâœ… DUPLICADOS ELIMINADOS: ${deletedCount}\n`;
        
      } catch (error) {
        output.textContent += `\nâŒ Error: ${error.message}\n`;
        console.error(error);
      }
    };

    window.cleanupOrphanAccounts = async function() {
      const orphanEmails = ['rincondeoz@gmail.com'];
      
      const confirmed = confirm(`âš ï¸ Â¿ELIMINAR cuentas huÃ©rfanas de Authentication?\n\nEmails:\n${orphanEmails.join('\n')}\n\nÂ¿Continuar?`);
      if (!confirmed) return;
      
      output.textContent = 'ğŸ§¹ LIMPIANDO CUENTAS HUÃ‰RFANAS...\n\n';
      
      let deletedCount = 0;
      
      for (const email of orphanEmails) {
        try {
          output.textContent += `ğŸ“§ ${email}\n`;
          
          // Verificar que NO existe en Firestore
          const usersSnapshot = await getDocs(collection(db, 'users'));
          const existsInFirestore = usersSnapshot.docs.some(doc => {
            const data = doc.data();
            return data.email && data.email.toLowerCase() === email.toLowerCase();
          });
          
          if (existsInFirestore) {
            output.textContent += `   âš ï¸ SKIP: Existe en Firestore\n\n`;
            continue;
          }
          
          // Intentar eliminar de Authentication
          try {
            const userCredential = await signInWithEmailAndPassword(auth, email, UNIVERSAL_PASSWORD);
            await deleteUser(userCredential.user);
            deletedCount++;
            output.textContent += `   âœ… Eliminado de Authentication\n\n`;
          } catch (authError) {
            if (authError.code === 'auth/user-not-found') {
              output.textContent += `   â„¹ï¸ Ya no existe\n\n`;
            } else {
              output.textContent += `   âš ï¸ ${authError.code}\n\n`;
            }
          }
          
        } catch (error) {
          output.textContent += `   âŒ Error: ${error.message}\n\n`;
        }
      }
      
      output.textContent += `âœ… HUÃ‰RFANAS ELIMINADAS: ${deletedCount}\n`;
    };

    window.resetRallyCounter = async function() {
      const confirmed = confirm('âš ï¸ Â¿RESETEAR el contador Rally a 0/1000?\n\nÂ¿Continuar?');
      if (!confirmed) return;
      
      output.textContent = 'ğŸ”„ RESETEANDO CONTADOR RALLY...\n\n';
      
      try {
        await setDoc(doc(db, 'system_stats', 'global'), {
          profilesCompleted: 0,
          membersActive: 0,
          lastUpdated: new Date().toISOString()
        }, { merge: true });
        
        output.textContent += 'âœ… Contador reseteado a 0/1000\n';
        
      } catch (error) {
        output.textContent += `âŒ Error: ${error.message}\n`;
        console.error(error);
      }
    };

    window.fullCleanup = async function() {
      const confirmed = confirm(
        'âš ï¸âš ï¸âš ï¸ LIMPIEZA COMPLETA DEL SISTEMA âš ï¸âš ï¸âš ï¸\n\n' +
        'Esto ejecutarÃ¡:\n' +
        '1. Limpiar duplicados de Firestore\n' +
        '2. Eliminar cuentas huÃ©rfanas de Auth\n' +
        '3. Resetear contador Rally a 0\n\n' +
        'Escribe "LIMPIAR" para confirmar:'
      );
      
      if (confirmed !== 'LIMPIAR') {
        output.textContent = 'OperaciÃ³n cancelada.\n';
        return;
      }
      
      output.textContent = 'ğŸš€ INICIANDO LIMPIEZA COMPLETA...\n\n';
      output.textContent += 'â•'.repeat(60) + '\n\n';
      
      // Paso 1: Duplicados
      output.textContent += 'PASO 1/3: Limpiando duplicados...\n';
      await cleanupFirestoreDuplicates();
      output.textContent += '\n' + 'â•'.repeat(60) + '\n\n';
      
      // Paso 2: HuÃ©rfanas
      output.textContent += 'PASO 2/3: Limpiando huÃ©rfanas...\n';
      await cleanupOrphanAccounts();
      output.textContent += '\n' + 'â•'.repeat(60) + '\n\n';
      
      // Paso 3: Contador
      output.textContent += 'PASO 3/3: Reseteando contador...\n';
      await resetRallyCounter();
      output.textContent += '\n' + 'â•'.repeat(60) + '\n\n';
      
      output.textContent += 'ğŸ‰ LIMPIEZA COMPLETA FINALIZADA\n';
      output.textContent += 'âœ… Sistema limpio y listo para empezar desde cero\n';
      
      setTimeout(() => {
        if (confirm('âœ… Â¿Recargar la pÃ¡gina?')) {
          window.location.reload();
        }
      }, 2000);
    };
  </script>
</body>
</html>

