<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiar Duplicados de Firestore</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #181B34;
      color: white;
    }
    button {
      background: #6161FF;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #4848CC;
    }
    pre {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    .warning {
      background: #FF6B6B;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üßπ Limpiar Duplicados de Firestore</h1>
  
  <div class="warning">
    ‚ö†Ô∏è <strong>ADVERTENCIA:</strong> Este script eliminar√° documentos duplicados de Firestore bas√°ndose en el email.
    Solo mantendr√° el documento m√°s reciente por email.
  </div>

  <button onclick="listDuplicates()">1Ô∏è‚É£ Listar Duplicados</button>
  <button onclick="cleanupDuplicates()">2Ô∏è‚É£ Limpiar Duplicados</button>
  
  <h2>üìã Resultados:</h2>
  <pre id="output">Presiona "Listar Duplicados" para ver los emails duplicados...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-RMcSBZ7eY9Y4CgH9Y0N6UKAj5Db_X4U",
      authDomain: "tribu-impulsa.firebaseapp.com",
      projectId: "tribu-impulsa",
      storageBucket: "tribu-impulsa.firebasestorage.app",
      messagingSenderId: "426607949701",
      appId: "1:426607949701:web:42effc9ce4a2bf1df90738",
      measurementId: "G-0R4H8ETRDB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const output = document.getElementById('output');

    window.listDuplicates = async function() {
      output.textContent = 'üîç Cargando usuarios de Firestore...\n\n';
      
      const usersCollection = collection(db, 'users');
      const snapshot = await getDocs(usersCollection);
      
      // Agrupar por email
      const emailMap = new Map();
      
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const email = (data.email || '').toLowerCase();
        
        if (!emailMap.has(email)) {
          emailMap.set(email, []);
        }
        
        emailMap.get(email).push({
          id: doc.id,
          email: data.email,
          name: data.name,
          createdAt: data.createdAt || '(sin fecha)',
          profileComplete: data.profileComplete
        });
      });
      
      // Mostrar duplicados
      let hasDuplicates = false;
      let report = `üìä TOTAL DE USUARIOS: ${snapshot.docs.length}\n\n`;
      
      for (const [email, users] of emailMap.entries()) {
        if (users.length > 1) {
          hasDuplicates = true;
          report += `‚ö†Ô∏è EMAIL DUPLICADO: ${email}\n`;
          report += `   Encontrados ${users.length} documentos:\n\n`;
          
          users.forEach((user, idx) => {
            report += `   ${idx + 1}. ID: ${user.id}\n`;
            report += `      Nombre: ${user.name}\n`;
            report += `      Creado: ${user.createdAt}\n`;
            report += `      Completo: ${user.profileComplete}\n\n`;
          });
          
          report += '   ---\n\n';
        }
      }
      
      if (!hasDuplicates) {
        report += '‚úÖ No se encontraron emails duplicados\n';
      }
      
      output.textContent = report;
    };

    window.cleanupDuplicates = async function() {
      const confirmed = confirm('‚ö†Ô∏è ¬øELIMINAR TODOS LOS DUPLICADOS?\n\nSolo se mantendr√° el documento m√°s reciente por email.\n\n¬øContinuar?');
      if (!confirmed) return;
      
      output.textContent = 'üßπ Iniciando limpieza de duplicados...\n\n';
      
      const usersCollection = collection(db, 'users');
      const snapshot = await getDocs(usersCollection);
      
      // Agrupar por email
      const emailMap = new Map();
      
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const email = (data.email || '').toLowerCase();
        
        if (!emailMap.has(email)) {
          emailMap.set(email, []);
        }
        
        emailMap.get(email).push({
          id: doc.id,
          email: data.email,
          name: data.name,
          createdAt: data.createdAt || '1970-01-01T00:00:00.000Z',
          data: data
        });
      });
      
      let deletedCount = 0;
      let report = '';
      
      for (const [email, users] of emailMap.entries()) {
        if (users.length > 1) {
          report += `\nüìß Procesando: ${email}\n`;
          report += `   Encontrados ${users.length} documentos\n`;
          
          // Ordenar por fecha de creaci√≥n (m√°s reciente primero)
          users.sort((a, b) => {
            const dateA = new Date(a.createdAt).getTime();
            const dateB = new Date(b.createdAt).getTime();
            return dateB - dateA;
          });
          
          const toKeep = users[0];
          const toDelete = users.slice(1);
          
          report += `   ‚úÖ Manteniendo: ${toKeep.id} (${toKeep.createdAt})\n`;
          
          for (const user of toDelete) {
            try {
              await deleteDoc(doc(db, 'users', user.id));
              deletedCount++;
              report += `   üóëÔ∏è Eliminado: ${user.id} (${user.createdAt})\n`;
            } catch (error) {
              report += `   ‚ùå Error eliminando ${user.id}: ${error.message}\n`;
            }
          }
        }
      }
      
      report += `\n‚úÖ LIMPIEZA COMPLETADA\n`;
      report += `   üì¶ Total eliminados: ${deletedCount}\n`;
      report += `   üìä Usuarios finales: ${snapshot.docs.length - deletedCount}\n`;
      
      output.textContent = report;
      
      setTimeout(() => {
        if (confirm('‚úÖ Limpieza completada.\n\n¬øRecargar la p√°gina para ver los cambios?')) {
          window.location.reload();
        }
      }, 1000);
    };
  </script>
</body>
</html>

